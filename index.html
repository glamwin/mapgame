<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Военный прототип: Киев–Донецк–Курск–Ростов</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    header {
      padding: 12px 16px 4px;
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    p.subtitle {
      margin: 4px 0 0;
      font-size: 12px;
      color: #9ca3af;
    }
    .layout {
      width: 100%;
      max-width: 1024px;
      padding: 8px 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    button {
      background: #1d4ed8;
      color: #e5e7eb;
      border: 1px solid #1d4ed8;
      border-radius: 999px;
      padding: 5px 11px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease-out, transform 0.1s ease-out, box-shadow 0.1s ease-out;
    }
    button.secondary {
      background: #0f172a;
      border-color: #334155;
    }
    button.active {
      background: #16a34a;
      border-color: #16a34a;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: #9ca3af;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-symbol {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #020617;
      font-size: 9px;
    }
    .ua { background: #1d4ed8; }
    .ru { background: #b91c1c; }
    .factory-symbol { background: #facc15; }
    .port-symbol { background: #0ea5e9; }

    .map-shell {
      background: radial-gradient(circle at top, #0b1120 0, #020617 50%, #000 100%);
      border-radius: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 36px rgba(0,0,0,0.7);
      padding: 10px;
    }
    svg {
      width: 100%;
      height: auto;
      display: block;
    }
    .land-ua {
      fill: #022c22;
      stroke: #064e3b;
      stroke-width: 2;
    }
    .land-ru {
      fill: #111827;
      stroke: #1f2937;
      stroke-width: 2;
    }
    .sea {
      fill: #0f172a;
      stroke: #1d4ed8;
      stroke-width: 1.5;
    }
    .border-line {
      stroke: #f97316;
      stroke-width: 2;
      stroke-dasharray: 6 4;
    }
    .river {
      fill: #0ea5e9;
      opacity: 0.85;
    }
    .grid-line {
      stroke: rgba(148,163,184,0.25);
      stroke-width: 1;
      stroke-dasharray: 4 4;
    }
    .grid-label {
      font-size: 9px;
      fill: #6b7280;
      pointer-events: none;
    }
    .city-label {
      font-size: 11px;
      fill: #e5e7eb;
      text-shadow: 0 0 3px #000;
      pointer-events: none;
    }
    .city-dot {
      fill: #f97316;
      stroke: #020617;
      stroke-width: 1.4;
    }
    .factory {
      fill: #facc15;
      stroke: #854d0e;
      stroke-width: 1.4;
    }
    .factory.destroyed {
      fill: #6b7280;
      stroke: #374151;
    }
    .port {
      fill: #0ea5e9;
      stroke: #020617;
      stroke-width: 1.4;
    }
    .airfield {
      fill: #e5e7eb;
      stroke: #020617;
      stroke-width: 1.3;
    }
    .unit {
      stroke: #020617;
      stroke-width: 1.8;
      cursor: pointer;
      transition: transform 0.1s ease-out;
    }
    .unit.selected {
      transform: scale(1.2);
    }
    .unit-ua { fill: #2563eb; }
    .unit-ru { fill: #dc2626; }
    .range-circle {
      fill: none;
      stroke: rgba(248,250,252,0.15);
      stroke-width: 1.2;
      stroke-dasharray: 4 4;
      pointer-events: none;
    }
    .info-panel {
      font-size: 12px;
      color: #9ca3af;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.85);
      border: 1px solid #1f2937;
    }
    .info-panel strong { color: #e5e7eb; font-weight: 500; }
    .log-panel {
      margin-top: 4px;
      font-size: 11px;
      color: #6b7280;
      font-family: monospace;
      background: rgba(15,23,42,0.8);
      border-radius: 10px;
      padding: 6px 10px;
      border: 1px solid #111827;
      max-height: 110px;
      overflow-y: auto;
      white-space: pre-line;
    }
  </style>
</head>
<body>
<header>
  <h1>Прототип операции: Киев — Донецк — Курск — Ростов</h1>
  <p class="subtitle">
    Условно-реальная карта, разные типы войск, дальность, скорость и объекты (заводы, порт, аэродром).
  </p>
</header>

<div class="layout">
  <div class="top-bar">
    <div class="controls">
      <button id="btnUA" class="active">Ход Украины</button>
      <button id="btnRU" class="secondary">Ход РФ</button>
      <button id="btnReset" class="secondary">Сброс</button>
    </div>
    <div class="legend">
      <div class="legend-item"><span class="legend-symbol ua">I</span> Пехота (сухопутная)</div>
      <div class="legend-item"><span class="legend-symbol ua">A</span> Арта (дальний огонь)</div>
      <div class="legend-item"><span class="legend-symbol ua">✈</span> Самолёт (аэродромы)</div>
      <div class="legend-item"><span class="legend-symbol ua">⚓</span> Корабль (море)</div>
      <div class="legend-item"><span class="legend-symbol factory-symbol"></span> Завод</div>
      <div class="legend-item"><span class="legend-symbol port-symbol"></span> Порт</div>
    </div>
  </div>

  <div class="map-shell">
    <!-- Условная карта: слева Украина, справа РФ, снизу море -->
    <svg id="map" viewBox="0 0 1000 500" xmlns="http://www.w3.org/2000/svg">
      <!-- Сетка км: условно 1px = 10 км, ширина ~1000px = 10 000 км (преувеличено для наглядности) -->
      <!-- Для прототипа важна сама идея: линии + подписи -->
      <g id="grid">
        <!-- вертикальные -->
        <line x1="100" y1="0" x2="100" y2="500" class="grid-line" />
        <text x="90" y="14" class="grid-label">≈1000 км</text>
        <line x1="300" y1="0" x2="300" y2="500" class="grid-line" />
        <text x="290" y="14" class="grid-label">≈3000 км</text>
        <line x1="500" y1="0" x2="500" y2="500" class="grid-line" />
        <text x="490" y="14" class="grid-label">≈5000 км</text>
        <line x1="700" y1="0" x2="700" y2="500" class="grid-line" />
        <text x="690" y="14" class="grid-label">≈7000 км</text>
        <line x1="900" y1="0" x2="900" y2="500" class="grid-line" />
        <text x="890" y="14" class="grid-label">≈9000 км</text>
      </g>

      <!-- Море (внизу справа) -->
      <rect x="550" y="320" width="450" height="180" class="sea" />

      <!-- Украина (левый массив) -->
      <path
        class="land-ua"
        d="
          M 40 60
          L 460 60
          L 520 110
          L 520 260
          L 480 310
          L 320 320
          L 260 350
          L 140 340
          L 60 300
          L 40 240
          Z
        "
      />
      <!-- РФ (правый массив) -->
      <path
        class="land-ru"
        d="
          M 520 60
          L 960 60
          L 960 280
          L 900 300
          L 780 290
          L 720 260
          L 650 270
          L 600 250
          L 560 220
          L 520 180
          Z
        "
      />

      <!-- Граница (условная линия между UA и РФ) -->
      <path
        class="border-line"
        d="
          M 520 60
          L 520 110
          L 520 180
          L 560 220
        "
      />

      <!-- Река (условный Днепр, стилизованно возле Киева) -->
      <path
        class="river"
        d="
          M 260 60
          C 270 120, 250 180, 270 230
          C 290 280, 260 320, 270 360
          L 300 380
          C 290 330, 310 280, 295 230
          C 280 180, 300 120, 290 60
          Z
        "
      />

      <!-- Города: Киев, Донецк, Курск, Ростов (условные координаты) -->
      <circle id="city_kyiv" class="city-dot" cx="260" cy="140" r="4" />
      <text x="270" y="136" class="city-label">Киев</text>

      <circle id="city_donetsk" class="city-dot" cx="420" cy="240" r="4" />
      <text x="430" y="236" class="city-label">Донецк</text>

      <circle id="city_kursk" class="city-dot" cx="640" cy="140" r="4" />
      <text x="650" y="136" class="city-label">Курск</text>

      <circle id="city_rostov" class="city-dot" cx="760" cy="260" r="4" />
      <text x="770" y="256" class="city-label">Ростов</text>

      <!-- Порт (в море, возле "Ростова") -->
      <rect id="port_azov" x="730" y="340" width="20" height="14" class="port" />
      <text x="755" y="350" class="city-label">Порт</text>

      <!-- Аэродром возле Киева -->
      <polygon
        id="airfield_kyiv"
        class="airfield"
        points="230,180 242,168 254,180 242,192"
      />
      <text x="210" y="200" class="city-label">Аэродром</text>

      <!-- Заводы (UA и РФ) -->
      <rect id="factory_ua" x="300" y="260" width="20" height="16" class="factory" />
      <text x="325" y="272" class="city-label">Завод UA</text>

      <rect id="factory_ru" x="680" y="200" width="20" height="16" class="factory" />
      <text x="705" y="212" class="city-label">Завод РФ</text>

      <!-- ДАЛЬНОСТЬ (круги) будут дорисовываться скриптом как <circle class="range-circle"> -->

      <!-- ЮНИТЫ -->
      <!-- Украина: пехота под Киевом -->
      <rect id="unit_ua_inf"
            class="unit unit-ua"
            data-side="UA" data-type="INF"
            x="245" y="155" width="14" height="14" rx="2" ry="2" />
      <!-- Украина: арта возле завода -->
      <rect id="unit_ua_art"
            class="unit unit-ua"
            data-side="UA" data-type="ART"
            x="330" y="260" width="16" height="10" />
      <!-- Украина: самолёт на аэродроме -->
      <polygon id="unit_ua_plane"
               class="unit unit-ua"
               data-side="UA" data-type="PLANE"
               points="242,200 248,210 242,222 236,210" />

      <!-- РФ: пехота возле Курска -->
      <rect id="unit_ru_inf"
            class="unit unit-ru"
            data-side="RU" data-type="INF"
            x="630" y="155" width="14" height="14" rx="2" ry="2" />
      <!-- РФ: арта возле завода РФ -->
      <rect id="unit_ru_art"
            class="unit unit-ru"
            data-side="RU" data-type="ART"
            x="710" y="200" width="16" height="10" />
      <!-- РФ: корабль в порту -->
      <circle id="unit_ru_ship"
              class="unit unit-ru"
              data-side="RU" data-type="SHIP"
              cx="740" cy="360" r="7" />

    </svg>
  </div>

  <div class="info-panel">
    <div><strong>Управление:</strong> клик по юниту — выбрать, клик по карте — задать точку движения.</div>
    <div>Скорость и дальность завязаны на условный масштаб (≈10 км на 1 пиксель). Арта и корабль автоматически разрушают завод, если входят в радиус.</div>
    <div>Самолёт может "садиться" на аэродром: если цель близко к аэродрому — считается, что он на базе.</div>
  </div>

  <div class="log-panel" id="log">
    Загрузка прототипа...
  </div>
</div>

<script>
  (function () {
    const svg = document.getElementById("map");
    const logEl = document.getElementById("log");

    const btnUA = document.getElementById("btnUA");
    const btnRU = document.getElementById("btnRU");
    const btnReset = document.getElementById("btnReset");

    const factoryUA = document.getElementById("factory_ua");
    const factoryRU = document.getElementById("factory_ru");
    const airfieldKyiv = document.getElementById("airfield_kyiv");
    const portAzov = document.getElementById("port_azov");

    let currentSide = "UA";  // "UA" или "RU"
    let selectedUnitId = null;

    // условный масштаб
    const KM_PER_PX = 10;

    // базовая модель юнитов
    const units = {
      unit_ua_inf: {
        id: "unit_ua_inf",
        type: "INF",
        side: "UA",
        speedKmH: 40,   // пехота
        rangeKm: 0,
        x: 252,
        y: 162,
      },
      unit_ua_art: {
        id: "unit_ua_art",
        type: "ART",
        side: "UA",
        speedKmH: 20,
        rangeKm: 80,   // дальность обстрела
        x: 338,
        y: 265,
      },
      unit_ua_plane: {
        id: "unit_ua_plane",
        type: "PLANE",
        side: "UA",
        speedKmH: 600,
        rangeKm: 200,  // зона действия для бомбометания
        x: 242,
        y: 210,
      },
      unit_ru_inf: {
        id: "unit_ru_inf",
        type: "INF",
        side: "RU",
        speedKmH: 40,
        rangeKm: 0,
        x: 637,
        y: 162,
      },
      unit_ru_art: {
        id: "unit_ru_art",
        type: "ART",
        side: "RU",
        speedKmH: 20,
        rangeKm: 80,
        x: 718,
        y: 205,
      },
      unit_ru_ship: {
        id: "unit_ru_ship",
        type: "SHIP",
        side: "RU",
        speedKmH: 30,
        rangeKm: 100,
        x: 740,
        y: 360,
      },
    };

    // текущие цели движения
    const movement = {
      // id: { targetX, targetY, vx, vy }
    };

    // range circles для арты/самолётов/кораблей
    const rangeCircles = {};

    function log(msg) {
      const t = new Date().toLocaleTimeString("ru-RU", { hour12: false });
      const current = logEl.textContent.trim();
      const line = `[${t}] ${msg}`;
      logEl.textContent = current ? line + "\n" + current : line;
    }

    function setTurn(side) {
      currentSide = side;
      if (side === "UA") {
        btnUA.classList.add("active");
        btnUA.classList.remove("secondary");
        btnRU.classList.add("secondary");
        btnRU.classList.remove("active");
      } else {
        btnRU.classList.add("active");
        btnRU.classList.remove("secondary");
        btnUA.classList.add("secondary");
        btnUA.classList.remove("active");
      }
      log(`Ход стороны: ${side}`);
      // снимаем выделение
      deselectAllUnits();
    }

    function deselectAllUnits() {
      Object.values(units).forEach(u => {
        const el = document.getElementById(u.id);
        el.classList.remove("selected");
      });
      selectedUnitId = null;
      removeAllRangeCircles();
    }

    function selectUnit(id) {
      const u = units[id];
      if (!u) return;
      if (u.side !== currentSide) {
        log(`Это юнит стороны ${u.side}, сейчас ход ${currentSide}.`);
        return;
      }
      deselectAllUnits();
      const el = document.getElementById(id);
      el.classList.add("selected");
      selectedUnitId = id;
      log(`Выбран юнит ${id} (${u.type}, сторона ${u.side}).`);
      drawRangeCircle(u);
    }

    function drawRangeCircle(u) {
      removeAllRangeCircles();
      if (!u.rangeKm || u.rangeKm <= 0) return;
      const rPx = u.rangeKm / KM_PER_PX;
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("class", "range-circle");
      circle.setAttribute("cx", u.x);
      circle.setAttribute("cy", u.y);
      circle.setAttribute("r", rPx);
      svg.appendChild(circle);
      rangeCircles[u.id] = circle;
    }

    function removeAllRangeCircles() {
      Object.keys(rangeCircles).forEach(id => {
        const c = rangeCircles[id];
        if (c && c.parentNode) c.parentNode.removeChild(c);
        delete rangeCircles[id];
      });
    }

    function setUnitPosition(id, x, y) {
      const u = units[id];
      if (!u) return;
      u.x = x;
      u.y = y;
      const el = document.getElementById(id);
      if (!el) return;
      const tag = el.tagName.toLowerCase();
      if (tag === "rect") {
        const w = parseFloat(el.getAttribute("width")) || 10;
        const h = parseFloat(el.getAttribute("height")) || 10;
        el.setAttribute("x", x - w / 2);
        el.setAttribute("y", y - h / 2);
      } else if (tag === "circle") {
        el.setAttribute("cx", x);
        el.setAttribute("cy", y);
      } else if (tag === "polygon") {
        // смещаем все точки полигона относительно центра
        const points = el.getAttribute("points").trim().split(" ").map(p => {
          const [px, py] = p.split(",").map(Number);
          return { px, py };
        });
        // на старте polygon уже стоит в нужном месте, лучше хранить смещения отдельно,
        // но для прототипа примем, что полигон маленький и допускаем грубость:
        // просто ставим его центром в (x,y) через transform
        el.setAttribute("transform", `translate(${x - u.x}, ${y - u.y})`);
      }
      // обновляем круг дальности
      drawRangeCircle(u);
    }

    function dist(x1,y1,x2,y2) {
      const dx = x2-x1, dy = y2-y1;
      return Math.sqrt(dx*dx+dy*dy);
    }

    function worldCoordsFromEvent(evt) {
      const pt = svg.createSVGPoint();
      pt.x = evt.clientX;
      pt.y = evt.clientY;
      const ctm = svg.getScreenCTM();
      if (!ctm) return { x: 0, y: 0 };
      const inv = ctm.inverse();
      const loc = pt.matrixTransform(inv);
      return { x: loc.x, y: loc.y };
    }

    function setMoveTarget(unitId, tx, ty) {
      const u = units[unitId];
      if (!u) return;
      // ограничения по типам:
      if (u.type === "SHIP") {
        // корабль должен оставаться в море (примитивная проверка по y>320 и x>550)
        if (!(tx > 550 && ty > 320)) {
          log("Корабль должен оставаться в море (нижняя правая зона).");
          return;
        }
      }
      const dx = tx - u.x;
      const dy = ty - u.y;
      const dPx = Math.sqrt(dx*dx + dy*dy);
      if (dPx < 1) return;
      const distKm = dPx * KM_PER_PX;
      const speed = u.speedKmH;
      const timeSec = (distKm / speed) * 3600; // t = s / v
      const vx = dx / timeSec;
      const vy = dy / timeSec;
      movement[unitId] = { targetX: tx, targetY: ty, vx, vy };
      log(`Юнит ${unitId} двигается на точку (${tx.toFixed(1)}, ${ty.toFixed(1)}). Расстояние ≈${distKm.toFixed(0)} км.`);
    }

    function stepMovement(dt) {
      const ids = Object.keys(movement);
      ids.forEach(id => {
        const u = units[id];
        const m = movement[id];
        if (!u || !m) return;
        const newX = u.x + m.vx * dt;
        const newY = u.y + m.vy * dt;
        const dToTarget = dist(newX, newY, m.targetX, m.targetY);
        if (dToTarget < 2) {
          setUnitPosition(id, m.targetX, m.targetY);
          delete movement[id];
          log(`Юнит ${id} достиг точки.`);
          checkEffects(u);
        } else {
          setUnitPosition(id, newX, newY);
          checkEffects(u);
        }
      });
    }

    // эффекты: разрушение заводов, "посадка" самолёта
    function checkEffects(u) {
      // дистанция до объектов
      const fUaBox = factoryUA.getBBox();
      const fUaX = fUaBox.x + fUaBox.width/2;
      const fUaY = fUaBox.y + fUaBox.height/2;

      const fRuBox = factoryRU.getBBox();
      const fRuX = fRuBox.x + fRuBox.width/2;
      const fRuY = fRuBox.y + fRuBox.height/2;

      const airBox = airfieldKyiv.getBBox();
      const airX = airBox.x + airBox.width/2;
      const airY = airBox.y + airBox.height/2;

      const portBox = portAzov.getBBox();
      const portX = portBox.x + portBox.width/2;
      const portY = portBox.y + portBox.height/2;

      // дальность в пикселях
      const rPx = u.rangeKm / KM_PER_PX;

      // Арта/корабль: ломают завод противника, если в радиусе
      if (u.type === "ART" || u.type === "SHIP") {
        if (u.side === "UA") {
          const d = dist(u.x, u.y, fRuX, fRuY);
          if (d <= rPx && !factoryRU.classList.contains("destroyed")) {
            factoryRU.classList.add("destroyed");
            log("Завод РФ уничтожен огнём UA.");
          }
        } else if (u.side === "RU") {
          const d = dist(u.x, u.y, fUaX, fUaY);
          if (d <= rPx && !factoryUA.classList.contains("destroyed")) {
            factoryUA.classList.add("destroyed");
            log("Завод UA уничтожен огнём РФ.");
          }
        }
      }

      // Самолёт UA: если рядом с аэродромом — считаем, что на базе
      if (u.type === "PLANE" && u.side === "UA") {
        const dAir = dist(u.x, u.y, airX, airY);
        if (dAir < 20) {
          // "посадка"
          // просто лог
          log("Самолёт UA находится на аэродроме под Киевом.");
        }
      }

      // Корабль РФ: если рядом с портом — "в порту"
      if (u.type === "SHIP" && u.side === "RU") {
        const dPort = dist(u.x, u.y, portX, portY);
        if (dPort < 20) {
          log("Корабль РФ находится в порту.");
        }
      }
    }

    // клики по юнитам
    Object.values(units).forEach(u => {
      const el = document.getElementById(u.id);
      if (!el) return;
      setUnitPosition(u.id, u.x, u.y); // выставим центр корректно
      el.addEventListener("click", (evt) => {
        evt.stopPropagation();
        selectUnit(u.id);
      });
    });

    // клик по карте (движение)
    svg.addEventListener("click", (evt) => {
      if (!selectedUnitId) return;
      const u = units[selectedUnitId];
      if (!u) return;
      const { x, y } = worldCoordsFromEvent(evt);
      setMoveTarget(u.id, x, y);
    });

    // смена хода
    btnUA.addEventListener("click", () => setTurn("UA"));
    btnRU.addEventListener("click", () => setTurn("RU"));

    // сброс
    btnReset.addEventListener("click", () => {
      // восстановим позицию юнитов и заводы
      units.unit_ua_inf.x = 252; units.unit_ua_inf.y = 162;
      units.unit_ua_art.x = 338; units.unit_ua_art.y = 265;
      units.unit_ua_plane.x = 242; units.unit_ua_plane.y = 210;

      units.unit_ru_inf.x = 637; units.unit_ru_inf.y = 162;
      units.unit_ru_art.x = 718; units.unit_ru_art.y = 205;
      units.unit_ru_ship.x = 740; units.unit_ru_ship.y = 360;

      Object.values(units).forEach(u => setUnitPosition(u.id, u.x, u.y));
      Object.keys(movement).forEach(id => delete movement[id]);
      factoryUA.classList.remove("destroyed");
      factoryRU.classList.remove("destroyed");
      deselectAllUnits();
      setTurn("UA");
      log("Сброс прототипа: позиции войск и заводов восстановлены.");
    });

    // основной цикл
    let lastTime = performance.now();
    function loop(now) {
      const dtSec = (now - lastTime)/1000;
      lastTime = now;
      stepMovement(dtSec);
      requestAnimationFrame(loop);
    }

    // старт
    setTurn("UA");
    log("Прототип загружен. Выбери юнит, кликни по карте — он пойдёт с реальной скоростью (в км/ч, переведённой в пиксели/сек). Арта и корабль могут разрушать заводы в радиусе.");

    requestAnimationFrame(loop);
  })();
</script>
</body>
</html>
