<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Хоррор-лабиринт: охотник vs жертва</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    header {
      padding: 12px 16px 4px;
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    p.subtitle {
      margin: 4px 0 0;
      font-size: 12px;
      color: #9ca3af;
    }
    .layout {
      width: 100%;
      max-width: 960px;
      padding: 8px 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }
    button {
      background: #1d4ed8;
      color: #e5e7eb;
      border: 1px solid #1d4ed8;
      border-radius: 999px;
      padding: 5px 11px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease-out, transform 0.1s ease-out, box-shadow 0.1s ease-out;
    }
    button.secondary {
      background: #0f172a;
      border-color: #334155;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    .container {
      background: radial-gradient(circle at top, #0b1120 0, #020617 50%, #000 100%);
      padding: 12px;
      border-radius: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 36px rgba(0,0,0,0.7);
    }
    canvas {
      display: block;
      border-radius: 10px;
      border: 1px solid #111827;
      background: #020617;
    }
    #doomCanvas {
      width: 800px;
      height: 450px;
      cursor: crosshair;
    }
    .info {
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
      max-width: 960px;
    }
    .info strong { color: #e5e7eb; }
    .log {
      font-size: 11px;
      color: #6b7280;
      font-family: monospace;
      background: rgba(15,23,42,0.85);
      border-radius: 10px;
      padding: 6px 10px;
      border: 1px solid #111827;
      max-height: 140px;
      overflow-y: auto;
      white-space: pre-line;
      width: 100%;
      max-width: 960px;
    }
  </style>
</head>
<body>
<header>
  <h1>Хоррор-лабиринт: Охотник против Жертвы</h1>
  <p class="subtitle">
    Псевдо-3D как старый Doom: мышь — обзор, банихоп-ускорение, спринт, присед, охота по лабиринту.
  </p>
</header>

<div class="layout">
  <div class="controls">
    <button id="lockBtn">Захват мыши</button>
    <button id="resetBtn" class="secondary">Сброс позиции</button>
  </div>

  <div class="container">
    <canvas id="doomCanvas" width="800" height="450"></canvas>
  </div>

  <div class="info">
    <div><strong>Игрок 1 (охотник, камера):</strong> W/S — вперёд/назад, A/D — страйф, Shift — спринт, Ctrl — присед, Space — прыжок (банихоп ускоряет), F — удар (если жертва рядом).</div>
    <div><strong>Игрок 2 (жертва, силуэт):</strong> стрелки ←↑↓→ — движение по лабиринту (виден как фигура в 3D).</div>
    <div>Нажми “Захват мыши”, наведи курсор на канвас и кликни — заработает обзор мышью. Выход мышью: Esc.</div>
  </div>

  <div class="log" id="logBox">Готово. Встаньте в канвас, включите захват мыши и бегайте по лабиринту.</div>
</div>

<script>
(function() {
  const canvas = document.getElementById('doomCanvas');
  const ctx = canvas.getContext('2d');
  const logBox = document.getElementById('logBox');
  const lockBtn = document.getElementById('lockBtn');
  const resetBtn = document.getElementById('resetBtn');

  function log(msg) {
    const t = new Date().toLocaleTimeString('ru-RU', { hour12: false });
    const line = `[${t}] ${msg}`;
    logBox.textContent = line + "\n" + logBox.textContent;
  }

  // ========= Pointer Lock (обзор мышью) =========
  lockBtn.addEventListener('click', () => {
    canvas.requestPointerLock();
  });

  document.addEventListener('pointerlockchange', () => {
    if (document.pointerLockElement === canvas) {
      log('Мышь захвачена. Двигай мышью — обзор.');
    } else {
      log('Мышь отпущена (Esc).');
    }
  });

  // ========= Управление =========
  const keys = {};
  window.addEventListener('keydown', e => { keys[e.code] = true; });
  window.addEventListener('keyup', e => { keys[e.code] = false; });

  let mouseDeltaX = 0;
  document.addEventListener('mousemove', e => {
    if (document.pointerLockElement === canvas) {
      mouseDeltaX += e.movementX;
    }
  });

  // ========= Карта-лабиринт (больше, чем раньше) =========
  // 0 — проход, 1 — стена
  const MAP_W = 24;
  const MAP_H = 24;
  const map = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,1],
    [1,0,1,1,1,0,1,1,0,1,0,1,1,0,1,0,1,0,1,0,1,1,0,1],
    [1,0,1,0,0,0,0,1,0,0,0,1,0,0,1,0,1,0,0,0,0,1,0,1],
    [1,0,1,0,1,1,0,1,1,1,0,1,0,1,1,0,1,1,1,1,0,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,1],
    [1,0,1,1,0,1,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,1,0,1],
    [1,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],
    [1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,1],
    [1,0,1,1,0,1,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,1,0,1],
    [1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],
    [1,0,1,0,1,1,0,1,1,1,0,1,0,1,1,0,1,1,1,1,0,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,1],
    [1,0,1,1,0,1,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,1,0,1],
    [1,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],
    [1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,1],
    [1,0,1,1,0,1,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,1,0,1],
    [1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],
    [1,0,1,0,1,1,0,1,1,1,0,1,0,1,1,0,1,1,1,1,0,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  ];

  function isWall(x, y) {
    if (x < 0 || x >= MAP_W || y < 0 || y >= MAP_H) return true;
    return map[Math.floor(y)][Math.floor(x)] === 1;
  }

  // ========= Игрок 1 (охотник) =========
  const player = {
    x: 2.5,
    y: 2.5,
    angle: 0,
    baseSpeed: 3.0,
    speed: 3.0,
    maxSpeed: 9.0,
    bunnyBoost: 1.4,
    friction: 3.0,
    rotSpeedMouse: 0.0025,
    crouch: false,
    eyeHeight: 0.5, // влияет на вертикальное смещение проекции
    isJumping: false,
    jumpCooldown: 0, // чтобы не спамить space
  };

  // ========= Игрок 2 (жертва) =========
  const victim = {
    x: 20.5,
    y: 20.5,
    speed: 2.8,
    alive: true,
  };

  // ========= Настройки рендера =========
  const W = canvas.width;
  const H = canvas.height;
  const HALF_H = H / 2;
  const FOV = Math.PI / 3;
  const HALF_FOV = FOV / 2;
  const NUM_RAYS = W;
  const PROJ_PLANE_DIST = (W / 2) / Math.tan(HALF_FOV);

  // ========= Лучи =========
  function castRay(rayAngle) {
    const step = 0.02;
    let dist = 0;
    let hit = false;
    let hitX = player.x;
    let hitY = player.y;

    const cos = Math.cos(rayAngle);
    const sin = Math.sin(rayAngle);

    while (!hit && dist < 30) {
      dist += step;
      hitX = player.x + cos * dist;
      hitY = player.y + sin * dist;
      if (isWall(hitX, hitY)) {
        hit = true;
      }
    }
    return { dist, hit, hitX, hitY };
  }

  // ========= Движение охотника (банихоп, спринт, присед) =========
  function movePlayer(dt) {
    // мышь — поворот
    if (document.pointerLockElement === canvas) {
      player.angle += mouseDeltaX * player.rotSpeedMouse;
    }
    mouseDeltaX = 0;

    const forward = (keys['KeyW'] || false) - (keys['KeyS'] || false);
    const strafe = (keys['KeyD'] || false) - (keys['KeyA'] || false);

    // спринт
    let targetSpeed = player.baseSpeed;
    if (keys['ShiftLeft'] || keys['ShiftRight']) {
      targetSpeed *= 1.7;
    }

    // присед
    if (keys['ControlLeft'] || keys['ControlRight']) {
      player.crouch = true;
      targetSpeed *= 0.5;
      player.eyeHeight = 0.35;
    } else {
      player.crouch = false;
      player.eyeHeight = 0.5;
    }

    // банихоп: если Space нажали при движении — буст
    player.jumpCooldown -= dt;
    if (player.jumpCooldown < 0) player.jumpCooldown = 0;
    if (keys['Space'] && player.jumpCooldown === 0 && (forward !== 0 || strafe !== 0)) {
      // увеличиваем текущую скорость
      player.speed = Math.min(player.speed * player.bunnyBoost, player.maxSpeed);
      player.jumpCooldown = 0.25; // нельзя прыгать слишком часто
    }

    // плавное стремление к targetSpeed
    if (player.speed < targetSpeed) {
      player.speed += 4 * dt;
    } else if (player.speed > targetSpeed) {
      player.speed -= player.friction * dt;
      if (player.speed < targetSpeed) player.speed = targetSpeed;
    }

    // движение по направлению
    const angle = player.angle;
    const cos = Math.cos(angle);
    const sin = Math.sin(angle);

    let dx = 0;
    let dy = 0;

    if (forward !== 0) {
      dx += cos * forward;
      dy += sin * forward;
    }
    if (strafe !== 0) {
      dx += sin * strafe;
      dy += -cos * strafe;
    }

    const len = Math.hypot(dx, dy) || 1;
    dx = dx / len * player.speed * dt;
    dy = dy / len * player.speed * dt;

    const newX = player.x + dx;
    const newY = player.y + dy;

    if (!isWall(newX, player.y)) player.x = newX;
    if (!isWall(player.x, newY)) player.y = newY;
  }

  // ========= Движение жертвы =========
  function moveVictim(dt) {
    if (!victim.alive) return;
    let vx = 0, vy = 0;
    if (keys['ArrowUp']) vy -= 1;
    if (keys['ArrowDown']) vy += 1;
    if (keys['ArrowLeft']) vx -= 1;
    if (keys['ArrowRight']) vx += 1;
    const len = Math.hypot(vx, vy) || 1;
    vx = vx / len * victim.speed * dt;
    vy = vy / len * victim.speed * dt;

    const newX = victim.x + vx;
    const newY = victim.y + vy;
    if (!isWall(newX, victim.y)) victim.x = newX;
    if (!isWall(victim.x, newY)) victim.y = newY;
  }

  // ========= Удар (F) =========
  function handleMelee() {
    if (!victim.alive) return;
    if (!keys['KeyF']) return;
    // дистанция до жертвы
    const dx = victim.x - player.x;
    const dy = victim.y - player.y;
    const dist = Math.hypot(dx, dy);
    if (dist < 0.7) {
      victim.alive = false;
      log('Охотник добрался до жертвы. Жертва убита.');
    }
  }

  // ========= Отрисовка =========
  function draw() {
    // фон: тёмное "небо" и "пол"
    ctx.fillStyle = '#020617';
    ctx.fillRect(0, 0, W, H / 2);
    ctx.fillStyle = '#050816';
    ctx.fillRect(0, H / 2, W, H / 2);

    // стены
    for (let x = 0; x < W; x++) {
      const screenX = x - W / 2;
      const rayAngle = player.angle + Math.atan(screenX / PROJ_PLANE_DIST);

      const result = castRay(rayAngle);

      let dist = result.dist;
      // устранение рыбьего глаза
      dist *= Math.cos(rayAngle - player.angle);

      const wallHeight = (1 * PROJ_PLANE_DIST) / dist;
      const eyeOffset = (player.eyeHeight - 0.5) * H * 0.6; // сдвиг горизонта при приседе
      const startY = Math.floor(H / 2 - wallHeight / 2 + eyeOffset);
      const endY = Math.floor(H / 2 + wallHeight / 2 + eyeOffset);

      let shade = 1 / (1 + dist * 0.1);
      if (shade > 1) shade = 1;
      if (shade < 0.1) shade = 0.1;
      const r = Math.floor(30 + 100 * shade);
      const g = Math.floor(20 + 80 * shade);
      const b = Math.floor(40 + 120 * shade);
      ctx.strokeStyle = `rgb(${r},${g},${b})`;
      ctx.beginPath();
      ctx.moveTo(x, startY);
      ctx.lineTo(x, endY);
      ctx.stroke();
    }

    // спрайт жертвы
    if (victim.alive) {
      drawVictimSprite();
    }

    drawHUD();
  }

  function drawVictimSprite() {
    const dx = victim.x - player.x;
    const dy = victim.y - player.y;
    const dist = Math.hypot(dx, dy);
    if (dist < 0.001) return;

    const angleTo = Math.atan2(dy, dx);
    let delta = angleTo - player.angle;
    while (delta > Math.PI) delta -= 2 * Math.PI;
    while (delta < -Math.PI) delta += 2 * Math.PI;

    if (Math.abs(delta) > HALF_FOV + 0.3) return; // вне поля зрения

    const spriteScreenX = Math.tan(delta) * PROJ_PLANE_DIST;
    const spriteSize = (1 * PROJ_PLANE_DIST) / dist;
    const xCenter = W / 2 + spriteScreenX;
    const eyeOffset = (player.eyeHeight - 0.5) * H * 0.6;
    const yMid = H / 2 + eyeOffset;
    const yTop = yMid - spriteSize / 2;

    const w = spriteSize * 0.6;
    const h = spriteSize * 1.2;

    // лёгкий "glow"
    ctx.fillStyle = 'rgba(148,27,27,0.3)';
    ctx.fillRect(xCenter - w, yTop - 10, w * 2, h + 20);

    ctx.fillStyle = '#f97316';
    ctx.fillRect(xCenter - w / 2, yTop, w, h);
    ctx.strokeStyle = '#111827';
    ctx.lineWidth = 2;
    ctx.strokeRect(xCenter - w / 2, yTop, w, h);

    // "глаза"
    ctx.fillStyle = '#facc15';
    ctx.fillRect(xCenter - w / 4, yTop + h * 0.2, 4, 4);
    ctx.fillRect(xCenter + w / 4 - 4, yTop + h * 0.2, 4, 4);
  }

  function drawHUD() {
    // нижняя панель
    ctx.fillStyle = 'rgba(15,23,42,0.7)';
    ctx.fillRect(0, H - 48, W, 48);

    // скорость
    ctx.fillStyle = '#e5e7eb';
    ctx.font = '11px system-ui';
    ctx.fillText('Скорость: ' + player.speed.toFixed(2), 12, H - 30);
    ctx.fillText('Жертва: ' + (victim.alive ? 'жива' : 'убита'), 12, H - 16);

    // простая "рука"/оружие снизу
    const gunW = W * 0.18;
    const gunH = 36;
    const gx = W / 2 - gunW / 2;
    const gy = H - gunH - 6;
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(gx, gy, gunW, gunH);
    ctx.strokeStyle = '#e5e7eb';
    ctx.lineWidth = 2;
    ctx.strokeRect(gx, gy, gunW, gunH);
    ctx.fillStyle = '#e5e7eb';
    ctx.fillRect(W/2 - 6, gy, 12, 8); // "ствол"
  }

  // ========= Цикл =========
  let lastTime = performance.now();
  function loop(now) {
    const dt = (now - lastTime) / 1000;
    lastTime = now;

    movePlayer(dt);
    moveVictim(dt);
    handleMelee();
    draw();

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ========= Сброс позиций =========
  resetBtn.addEventListener('click', () => {
    player.x = 2.5;
    player.y = 2.5;
    player.angle = 0;
    player.speed = player.baseSpeed;
    victim.x = 20.5;
    victim.y = 20.5;
    victim.alive = true;
    log('Позиции сброшены. Охотник и жертва вернулись на старт.');
  });

  log('Прототип загружен. Игрок 1 — охотник (WASD, Shift, Ctrl, Space, F, мышь), Игрок 2 — жертва (стрелки).');
})();
</script>
</body>
</html>
